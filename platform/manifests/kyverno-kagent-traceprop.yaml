# Kyverno ClusterPolicy â€” injects DISABLE_AIOHTTP_TRANSPORT=True on kagent Agent CRDs.
#
# Why: litellm defaults to aiohttp for HTTP transport, which is NOT instrumented
# by OpenTelemetry. This means outbound LLM calls don't propagate the traceparent
# header, breaking distributed trace linking between AgentGateway and LLM backends.
# Setting DISABLE_AIOHTTP_TRANSPORT=True forces litellm to use httpx, which OTEL
# auto-instruments for W3C trace context propagation.
#
# Scope: all Declarative Agents across all namespaces. The kagent controller reads
# spec.declarative.deployment.env and injects the vars into the agent pod spec.
#
# See also: kyverno-a2a-appprotocol.yaml (companion policy for A2A service discovery)
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kagent-traceprop
  annotations:
    policies.kyverno.io/title: Inject DISABLE_AIOHTTP_TRANSPORT on kagent Agents
    policies.kyverno.io/category: Observability
    policies.kyverno.io/description: >-
      Injects DISABLE_AIOHTTP_TRANSPORT=True into all kagent Declarative Agent
      CRDs so litellm uses httpx (OTEL-instrumented) instead of aiohttp,
      enabling traceparent propagation on outbound LLM calls.
spec:
  rules:
    - name: inject-disable-aiohttp
      match:
        any:
          - resources:
              kinds:
                - kagent.dev/v1alpha2/Agent
      preconditions:
        all:
          - key: "{{ request.object.spec.type }}"
            operator: Equals
            value: "Declarative"
      mutate:
        patchStrategicMerge:
          spec:
            declarative:
              deployment:
                env:
                  - name: DISABLE_AIOHTTP_TRANSPORT
                    value: "True"
