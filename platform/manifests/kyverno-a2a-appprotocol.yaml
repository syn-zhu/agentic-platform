# Kyverno ClusterPolicy — injects appProtocol: kgateway.dev/a2a on kagent agent Services.
#
# Opt-in: add the annotation `platform.agentic.io/expose: "true"` to your Agent CR.
# kagent propagates annotations to child resources, so the Service will have it
# too. Kyverno matches on this annotation and injects the appProtocol field.
#
# Example Agent CR:
#   metadata:
#     annotations:
#       platform.agentic.io/expose: "true"
#
# This policy is a platform-level workaround until kagent natively sets
# appProtocol. See: https://github.com/kagent-dev/kagent/issues/1295
#
# Known issue: the agentgateway admin UI (port 19000) does not detect A2A
# backends correctly in XDS/Kubernetes mode — they show as "Service" instead
# of "A2A". The proxy itself handles A2A routing correctly; this is purely
# a UI rendering gap. See: https://github.com/agentgateway/agentgateway/issues/978
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: inject-a2a-appprotocol
  annotations:
    policies.kyverno.io/title: Inject A2A appProtocol on kagent Services
    policies.kyverno.io/category: AgentGateway Integration
    policies.kyverno.io/description: >-
      Opt-in policy: injects appProtocol kgateway.dev/a2a on kagent agent
      Services annotated with platform.agentic.io/expose=true, enabling
      AgentGateway A2A plugin discovery.
spec:
  rules:
    - name: add-a2a-appprotocol
      match:
        any:
          - resources:
              kinds:
                - Service
              selector:
                matchLabels:
                  app: kagent
      preconditions:
        all:
          - key: "{{ request.object.metadata.ownerReferences[?kind=='Agent'] || `[]` | length(@) }}"
            operator: GreaterThan
            value: 0
          - key: "{{ request.object.metadata.annotations.\"platform.agentic.io/expose\" || '' }}"
            operator: Equals
            value: "true"
      mutate:
        patchesJson6902: |-
          - op: add
            path: /spec/ports/0/appProtocol
            value: "kgateway.dev/a2a"
